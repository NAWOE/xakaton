<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Туры по Вологде</title>
    <!-- Подключаем Bootstrap  -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Подключаем карту Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 600px; width: 100%; border-radius: 10px; }
        .place-item { cursor: pointer; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4">
    <h1 class="text-center mb-4"> Планировщик маршрута (Вологда)</h1>

    <div class="row">
        <!-- ЛЕВАЯ КОЛОНКА: Настройки -->
        <div class="col-md-4">
            <div class="card p-3 shadow-sm">
                <form method="post">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label">Максимальная длина (метры):</label>
                        <input type="number" name="distance" value="{{ max_d }}" class="form-control" required>
                    </div>

                    <h5>Выберите места:</h5>
                    <div class="list-group mb-3">
                        {% for place in places %}
                        <label class="list-group-item">
                            <input class="form-check-input me-1" type="checkbox" name="places" value="{{ place.id }}"
                                   {% if place.id in selected_ids %}checked{% endif %}>
                            {{ place.name }}
                        </label>
                        {% endfor %}
                    </div>

                    <button type="submit" class="btn btn-primary w-100"> Построить маршрут</button>
                </form>
            </div>

            <!-- Результаты -->
            {% if route %}
            <div class="card mt-3 p-3 border-success shadow-sm">
                <h5 class="text-success">Найденный маршрут ({{ route|length }} объектов):</h5>
                <ol>
                    {% for point in route %}
                        <li>{{ point.name }}</li>
                    {% endfor %}
                </ol>
            </div>
            {% endif %}
        </div>

        <!КОЛОНКА Карт >
        <div class="col-md-8">
            <div id="map" class="shadow-sm"></div>
        </div>
    </div>
</div>

<!-- Скрипты карты -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Инициализация карты (центр Вологды)
    var map = L.map('map').setView([59.2239, 39.8825], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // 2. Добавляем все точки на карту
    var placesData = [
        {% for place in places %}
            {
                id: {{ place.id }},
                name: "{{ place.name }}",
                lat: {{ place.lat|stringformat:"f" }}, // хак для замены запятой на точку
                lon: {{ place.lon|stringformat:"f" }}
            },
        {% endfor %}
    ];

    placesData.forEach(function(p) {
        L.marker([p.lat, p.lon]).addTo(map)
            .bindPopup("<b>" + p.name + "</b>");
    });

    // 3. Если есть маршрут - рисуем линию
    {% if route %}
        var routePoints = [
            {% for point in route %}
                [{{ point.lat|stringformat:"f" }}, {{ point.lon|stringformat:"f" }}],
            {% endfor %}
        ];

        // Рисуем красную линию
        var polyline = L.polyline(routePoints, {color: 'red', weight: 5}).addTo(map);
        // Зуммируем карту, чтобы показать весь маршрут
        map.fitBounds(polyline.getBounds());
    {% endif %}
</script>

</body>
</html>