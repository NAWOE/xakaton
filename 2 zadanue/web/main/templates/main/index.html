<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—É—Ä—ã –ø–æ –í–æ–ª–æ–≥–¥–µ</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap  -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–∞—Ä—Ç—É Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 500px;
            width: 100%;
            border-radius: 10px;
        }
        .place-item { cursor: pointer; }
        .drawing-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
        }
        .selection-active {
            background-color: #e7f3ff !important;
            border-color: #0d6efd !important;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 768px) {
            #map {
                height: 400px;
                margin-bottom: 15px;
            }
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            .drawing-controls {
                padding: 10px;
            }
        }

        @media (max-width: 576px) {
            #map {
                height: 350px;
            }
            .btn-group-vertical {
                width: 100%;
            }
        }

        .marker-selected {
            filter: hue-rotate(120deg) saturate(200%);
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-3 mt-md-4">
    <h1 class="text-center mb-3 mb-md-4">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–∞—Ä—à—Ä—É—Ç–∞ (–í–æ–ª–æ–≥–¥–∞)</h1>

    <div class="row">
        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="col-lg-4 col-md-5 mb-3 mb-md-0">
            <div class="card p-3 shadow-sm h-100">
                <form method="post" id="routeForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ (–º–µ—Ç—Ä—ã):</label>
                        <input type="number" name="distance" value="{{ max_d }}" class="form-control" required min="100" max="10000">
                    </div>

                    <!-- –ë–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –æ–±–ª–∞—Å—Ç–∏ -->
                    <div class="drawing-controls">
                        <h6 class="mb-3">–í—ã–¥–µ–ª–µ–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç–µ:</h6>
                        <div class="btn-group-vertical w-100" role="group">
                            <button type="button" id="startDrawing" class="btn btn-success mb-2">
                                –ù–∞—á–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                            </button>
                            <button type="button" id="finishDrawing" class="btn btn-primary mb-2" disabled>
                                –ó–∞–≤–µ—Ä—à–∏—Ç—å
                            </button>
                            <button type="button" id="clearSelection" class="btn btn-outline-secondary">
                                –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                            </button>
                        </div>
                        <div class="form-text small mt-2">
                             –ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫–∏ –æ–±–ª–∞—Å—Ç–∏. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏.
                        </div>
                    </div>

                    <h5 class="mt-3">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞:</h5>
                    <div class="list-group mb-3" id="placesList" style="max-height: 300px; overflow-y: auto;">
                        {% for place in places %}
                        <label class="list-group-item place-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" name="places" value="{{ place.id }}"
                                   {% if place.id in selected_ids %}checked{% endif %}>
                            <span class="flex-grow-1">{{ place.name }}</span>
                        </label>
                        {% endfor %}
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-2">
                         –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
                    </button>
                </form>
            </div>
        </div>

        <!-- –ö–û–õ–û–ù–ö–ê –ö–∞—Ä—Ç—ã -->
        <div class="col-lg-8 col-md-7">
            <div class="card shadow-sm h-100">
                <div class="card-body p-0">
                    <div id="map" class="w-100"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞ -->
    {% if route %}
    <div class="row mt-3">
        <div class="col-12">
            <div class="card p-3 border-success shadow-sm">
                <h5 class="text-success mb-3">üó∫Ô∏è –ù–∞–π–¥–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç ({{ route|length }} –æ–±—ä–µ–∫—Ç–æ–≤):</h5>
                <div class="row">
                    <div class="col-md-8">
                        <ol class="mb-0">
                            {% for point in route %}
                                <li class="mb-2"><strong>{{ point.name }}</strong></li>
                            {% endfor %}
                        </ol>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <span class="badge bg-success fs-6">–ì–æ—Ç–æ–≤–æ!</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- –°–∫—Ä–∏–ø—Ç—ã –∫–∞—Ä—Ç—ã -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (—Ü–µ–Ω—Ç—Ä –í–æ–ª–æ–≥–¥—ã)
    var map = L.map('map').setView([59.2239, 39.8825], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // 2. –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
    var placesData = [
        {% for place in places %}
            {
                id: {{ place.id }},
                name: "{{ place.name }}",
                lat: {{ place.lat|stringformat:"f" }},
                lon: {{ place.lon|stringformat:"f" }}
            },
        {% endfor %}
    ];

    var markers = [];
    var selectedMarkers = new Set();

    // –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏–∫–æ–Ω–∫–∏
    var defaultIcon = new L.Icon.Default();
    var selectedIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    placesData.forEach(function(p) {
        var marker = L.marker([p.lat, p.lon], { icon: defaultIcon }).addTo(map)
            .bindPopup("<b>" + p.name + "</b><br><small>–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</small>");

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä
        marker.placeId = p.id;
        markers.push(marker);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –º–∞—Ä–∫–µ—Ä—É
        marker.on('click', function() {
            togglePlaceSelection(p.id);
        });
    });

    // 3. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –æ–±–ª–∞—Å—Ç–∏
    var isDrawing = false;
    var polygonPoints = [];
    var selectionPolygon = null;
    var pointMarkers = [];

    // 4. –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º
    function startDrawing() {
        isDrawing = true;
        polygonPoints = [];
        clearSelectionVisuals();
        document.getElementById('startDrawing').disabled = true;
        document.getElementById('finishDrawing').disabled = false;
        document.getElementById('startDrawing').classList.add('selection-active');
        map.doubleClickZoom.disable();

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        updateDrawingHint('–ö–ª–∏–∫–∞–π—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫–∏ –æ–±–ª–∞—Å—Ç–∏. –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ - –∑–∞–≤–µ—Ä—à–∏—Ç—å.');
    }

    function finishDrawing() {
        if (polygonPoints.length >= 3) {
            isDrawing = false;
            document.getElementById('startDrawing').disabled = false;
            document.getElementById('finishDrawing').disabled = true;
            document.getElementById('startDrawing').classList.remove('selection-active');
            map.doubleClickZoom.enable();
            updateSelectionFromPolygon();
            updateDrawingHint('–í—ã–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –í—ã–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ –æ—Ç–º–µ—á–µ–Ω—ã.');
        } else {
            alert('–î–æ–±–∞–≤—å—Ç–µ –∫–∞–∫ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±–ª–∞—Å—Ç–∏');
        }
    }

    function clearSelection() {
        isDrawing = false;
        polygonPoints = [];
        clearSelectionVisuals();
        document.getElementById('startDrawing').disabled = false;
        document.getElementById('finishDrawing').disabled = true;
        document.getElementById('startDrawing').classList.remove('selection-active');
        map.doubleClickZoom.enable();

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
        selectedMarkers.clear();
        updateCheckboxesFromSelection();
        updateMarkersAppearance();
        updateDrawingHint('–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–µ–ª–µ–Ω–∏—é –Ω–æ–≤–æ–π –æ–±–ª–∞—Å—Ç–∏.');
    }

    function clearSelectionVisuals() {
        // –£–¥–∞–ª—è–µ–º –ø–æ–ª–∏–≥–æ–Ω
        if (selectionPolygon) {
            map.removeLayer(selectionPolygon);
            selectionPolygon = null;
        }

        // –£–¥–∞–ª—è–µ–º —Ç–æ—á–∫–∏
        pointMarkers.forEach(function(marker) {
            map.removeLayer(marker);
        });
        pointMarkers = [];
    }

    function updateDrawingHint(message) {
        var hintElement = document.querySelector('.drawing-controls .form-text');
        if (hintElement) {
            hintElement.innerHTML = '' + message;
        }
    }

    // 5. –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ–ª–∏–≥–æ–Ω–∞ (—Å–≤—è–∑—ã–≤–∞–Ω–∏–µ —Ç–æ—á–µ–∫)
    function updatePolygon() {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø–æ–ª–∏–≥–æ–Ω
        if (selectionPolygon) {
            map.removeLayer(selectionPolygon);
        }

        if (polygonPoints.length >= 3) {
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫ –¥–ª—è –ø–æ–ª–∏–≥–æ–Ω–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É
            var polygonPointsArray = [];

            if (polygonPoints.length === 3) {
                // –î–ª—è 3 —Ç–æ—á–µ–∫: —Å–≤—è–∑—ã–≤–∞–µ–º 1-2-3
                polygonPointsArray = [polygonPoints[0], polygonPoints[1], polygonPoints[2]];
            } else if (polygonPoints.length > 3) {
                // –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Ç–æ—á–∫–∏: —Å–≤—è–∑—ã–≤–∞–µ–º —Å 1 –∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–π
                polygonPointsArray = [polygonPoints[0], polygonPoints[1]];

                for (var i = 2; i < polygonPoints.length; i++) {
                    polygonPointsArray.push(polygonPoints[i]);
                }

                // –ó–∞–º—ã–∫–∞–µ–º –ø–æ–ª–∏–≥–æ–Ω
                polygonPointsArray.push(polygonPoints[0]);
            }

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø–æ–ª–∏–≥–æ–Ω
            selectionPolygon = L.polygon(polygonPointsArray, {
                color: 'blue',
                fillColor: '#3388ff',
                fillOpacity: 0.3,
                weight: 3
            }).addTo(map);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±–æ—Ä
            updateSelectionFromPolygon();
        }
    }

    // 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–∏–≥–æ–Ω–∞
    function updateSelectionFromPolygon() {
        if (!selectionPolygon || polygonPoints.length < 3) return;

        selectedMarkers.clear();

        markers.forEach(function(marker) {
            var latlng = marker.getLatLng();
            if (isPointInPolygon(latlng, polygonPoints)) {
                selectedMarkers.add(marker.placeId);
            }
        });

        updateCheckboxesFromSelection();
        updateMarkersAppearance();
    }

    // 7. –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ—á–∫–∏ –≤ –ø–æ–ª–∏–≥–æ–Ω–µ (–∞–ª–≥–æ—Ä–∏—Ç–º ray casting)
    function isPointInPolygon(point, vs) {
        var x = point.lat, y = point.lng;
        var inside = false;

        for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
            var xi = vs[i].lat, yi = vs[i].lng;
            var xj = vs[j].lat, yj = vs[j].lng;

            var intersect = ((yi > y) != (yj > y))
                && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }

        return inside;
    }

    // 8. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ –∏ –º–∞—Ä–∫–µ—Ä–æ–≤
    function togglePlaceSelection(placeId) {
        if (selectedMarkers.has(placeId)) {
            selectedMarkers.delete(placeId);
        } else {
            selectedMarkers.add(placeId);
        }
        updateCheckboxesFromSelection();
        updateMarkersAppearance();
    }

    function updateCheckboxesFromSelection() {
        var checkboxes = document.querySelectorAll('input[name="places"]');
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = selectedMarkers.has(parseInt(checkbox.value));
        });
    }

    function updateMarkersAppearance() {
        markers.forEach(function(marker) {
            if (selectedMarkers.has(marker.placeId)) {
                marker.setIcon(selectedIcon);
            } else {
                marker.setIcon(defaultIcon);
            }
        });
    }

    // 9. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫–∞—Ä—Ç—ã
    map.on('click', function(e) {
        if (isDrawing) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É
            polygonPoints.push(e.latlng);

            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä —Ç–æ—á–∫–∏
            var pointMarker = L.circleMarker(e.latlng, {
                radius: 6,
                fillColor: 'red',
                color: 'darkred',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            pointMarkers.push(pointMarker);

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–∏–≥–æ–Ω –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É
            updatePolygon();
        }
    });

    // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    map.on('dblclick', function(e) {
        if (isDrawing && polygonPoints.length >= 3) {
            finishDrawing();
        }
    });

    // 10. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–Ω–æ–ø–æ–∫
    document.getElementById('startDrawing').addEventListener('click', startDrawing);
    document.getElementById('finishDrawing').addEventListener('click', finishDrawing);
    document.getElementById('clearSelection').addEventListener('click', clearSelection);

    // 11. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ –∏–∑ —Ñ–æ—Ä–º—ã
    document.addEventListener('DOMContentLoaded', function() {
        var initialCheckboxes = document.querySelectorAll('input[name="places"]:checked');
        initialCheckboxes.forEach(function(checkbox) {
            selectedMarkers.add(parseInt(checkbox.value));
        });
        updateMarkersAppearance();
    });

    // 12. –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç - —Ä–∏—Å—É–µ–º –ª–∏–Ω–∏—é
    {% if route %}
        var routePoints = [
            {% for point in route %}
                [{{ point.lat|stringformat:"f" }}, {{ point.lon|stringformat:"f" }}],
            {% endfor %}
        ];

        // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –Ω–∞–∑–≤–∞–Ω–∏–π –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞
        var routeNames = [
            {% for point in route %}
                "{{ point.name }}",
            {% endfor %}
        ];

        // –†–∏—Å—É–µ–º –∫—Ä–∞—Å–Ω—É—é –ª–∏–Ω–∏—é
        var polyline = L.polyline(routePoints, {
            color: 'red',
            weight: 5,
            opacity: 0.7
        }).addTo(map);

        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞ —Å –Ω–æ–º–µ—Ä–∞–º–∏
        routePoints.forEach(function(point, index) {
            L.marker(point, {
                icon: L.divIcon({
                    className: 'route-marker',
                    html: '<div style="background: red; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold;">' + (index + 1) + '</div>',
                    iconSize: [25, 25],
                    iconAnchor: [12, 12]
                })
            }).addTo(map).bindPopup('<strong>' + (index + 1) + '. ' + routeNames[index] + '</strong>');
        });

        // –ó—É–º–º–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –≤–µ—Å—å –º–∞—Ä—à—Ä—É—Ç
        map.fitBounds(polyline.getBounds());
    {% endif %}
</script>

</body>
</html>