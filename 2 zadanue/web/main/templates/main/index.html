<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Туры по Вологде</title>
    <!-- Подключаем Bootstrap  -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Подключаем карту Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 500px;
            width: 100%;
            border-radius: 10px;
        }
        .place-item { cursor: pointer; }
        .drawing-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
        }
        .selection-active {
            background-color: #e7f3ff !important;
            border-color: #0d6efd !important;
        }
        .saved-routes {
            max-height: 400px;
            overflow-y: auto;
        }
        .route-item {
            border-left: 4px solid #0d6efd;
            transition: all 0.3s ease;
        }
        .route-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }

        /* Адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            #map {
                height: 400px;
                margin-bottom: 15px;
            }
            .container {
                padding-left: 10px;
                padding-right: 10px;
            }
            .drawing-controls {
                padding: 10px;
            }
        }

        @media (max-width: 576px) {
            #map {
                height: 350px;
            }
            .btn-group-vertical {
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-3 mt-md-4">
    <h1 class="text-center mb-3 mb-md-4">Планировщик маршрута (Вологда)</h1>

    <div class="row">
        <!-- ЛЕВАЯ КОЛОНКА: Настройки -->
        <div class="col-lg-4 col-md-5 mb-3 mb-md-0">
            <div class="card p-3 shadow-sm h-100">
                <form method="post" id="routeForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label">Максимальная длина (метры):</label>
                        <input type="number" name="distance" value="{{ max_d }}" class="form-control" required min="100" max="10000">
                    </div>

                    <!-- Блок управления выделением области -->
                    <div class="drawing-controls">
                        <h6 class="mb-3">Выделение области на карте:</h6>
                        <div class="btn-group-vertical w-100" role="group">
                            <button type="button" id="startDrawing" class="btn btn-success mb-2">
                                Начать выделение
                            </button>
                            <button type="button" id="finishDrawing" class="btn btn-primary mb-2" disabled>
                                Завершить
                            </button>
                            <button type="button" id="clearSelection" class="btn btn-outline-secondary">
                                Очистить выделение
                            </button>
                        </div>
                        <div class="form-text small mt-2">
                            Кликайте на карте, чтобы добавить точки области. Нужно минимум 3 точки.
                        </div>
                    </div>

                    <h5 class="mt-3">Выберите места:</h5>
                    <div class="list-group mb-3" id="placesList" style="max-height: 300px; overflow-y: auto;">
                        {% for place in places %}
                        <label class="list-group-item place-item d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" name="places" value="{{ place.id }}"
                                   {% if place.id in selected_ids %}checked{% endif %}>
                            <span class="flex-grow-1">{{ place.name }}</span>
                        </label>
                        {% endfor %}
                    </div>

                    <button type="submit" name="build_route" class="btn btn-primary w-100 py-2">
                        Построить маршрут
                    </button>
                </form>
            </div>
        </div>

        <!-- КОЛОНКА Карты -->
        <div class="col-lg-8 col-md-7">
            <div class="card shadow-sm h-100">
                <div class="card-body p-0">
                    <div id="map" class="w-100"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Результаты маршрута и сохранение -->
    {% if route %}
    <div class="row mt-3">
        <div class="col-12">
            <div class="card p-3 border-success shadow-sm">
                <h5 class="text-success mb-3">Найденный маршрут ({{ route|length }} объектов):</h5>
                <div class="row">
                    <div class="col-md-8">
                        <ol class="mb-0">
                            {% for point in route %}
                                <li class="mb-2"><strong>{{ point.name }}</strong></li>
                            {% endfor %}
                        </ol>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <span class="badge bg-success fs-6">Готово!</span>
                    </div>
                </div>

                <!-- Форма сохранения маршрута -->
                <div class="mt-4 p-3 bg-light rounded">
                    <h6>Сохранить этот маршрут:</h6>
                    <form method="post" class="row g-2">
                        {% csrf_token %}
                        <div class="col-md-6">
                            <input type="text" name="route_name" class="form-control" placeholder="Название маршрута" required maxlength="200">
                        </div>
                        <div class="col-md-4">
                            <input type="text" name="route_description" class="form-control" placeholder="Описание (необязательно)" maxlength="500">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" name="save_route" class="btn btn-success w-100">Сохранить</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Сохраненные маршруты -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Сохраненные маршруты</h5>
                </div>
                <div class="card-body">
                    {% if saved_routes %}
                    <div class="saved-routes">
                        {% for saved_route in saved_routes %}
                        <div class="route-item card mb-2">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">{{ saved_route.name }}</h6>
                                        <p class="mb-1 text-muted small">
                                            {{ saved_route.description|default:"Без описания" }}
                                        </p>
                                        <small class="text-muted">
                                            Макс. расстояние: {{ saved_route.max_distance }}м •
                                            Точек: {{ saved_route.points.count }} •
                                            Создан: {{ saved_route.created_at|date:"d.m.Y H:i" }}
                                        </small>
                                    </div>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-outline-primary btn-sm load-route"
                                                data-route-id="{{ saved_route.id }}">
                                            Загрузить
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm delete-route"
                                                data-route-id="{{ saved_route.id }}">
                                            Удалить
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center">Пока нет сохраненных маршрутов</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Скрипты карты -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Инициализация карты (центр Вологды)
    var map = L.map('map').setView([59.2239, 39.8825], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // 2. Глобальные переменные
    var markers = [];
    var selectedMarkers = new Set();
    var currentRoutePolyline = null;
    var currentRouteMarkers = [];
    var isDrawing = false;
    var polygonPoints = [];
    var selectionPolygon = null;
    var pointMarkers = [];

    // Создаем кастомные иконки
    var defaultIcon = new L.Icon.Default();
    var selectedIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // 3. Добавляем все точки на карту
    var placesData = [
        {% for place in places %}
            {
                id: {{ place.id }},
                name: "{{ place.name }}",
                lat: {{ place.lat|stringformat:"f" }},
                lon: {{ place.lon|stringformat:"f" }}
            },
        {% endfor %}
    ];

    placesData.forEach(function(p) {
        var marker = L.marker([p.lat, p.lon], { icon: defaultIcon }).addTo(map)
            .bindPopup("<b>" + p.name + "</b><br><small>Кликните для выбора</small>");

        marker.placeId = p.id;
        markers.push(marker);

        marker.on('click', function() {
            togglePlaceSelection(p.id);
        });
    });

    // 4. Функции для работы с маршрутами
    function clearCurrentRoute() {
        if (currentRoutePolyline) {
            map.removeLayer(currentRoutePolyline);
            currentRoutePolyline = null;
        }
        currentRouteMarkers.forEach(function(marker) {
            map.removeLayer(marker);
        });
        currentRouteMarkers = [];
    }

    function displayRoute(routePoints, routeNames, maxDistance) {
        clearCurrentRoute();

        // Рисуем линию маршрута
        currentRoutePolyline = L.polyline(routePoints, {
            color: 'red',
            weight: 5,
            opacity: 0.7
        }).addTo(map);

        // Добавляем маркеры с номерами
        routePoints.forEach(function(point, index) {
            var marker = L.marker(point, {
                icon: L.divIcon({
                    className: 'route-marker',
                    html: '<div style="background: red; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold;">' + (index + 1) + '</div>',
                    iconSize: [25, 25],
                    iconAnchor: [12, 12]
                })
            }).addTo(map).bindPopup('<strong>' + (index + 1) + '. ' + routeNames[index] + '</strong>');

            currentRouteMarkers.push(marker);
        });

        // Зуммируем карту на маршрут
        map.fitBounds(currentRoutePolyline.getBounds());
    }

    // 5. Загрузка сохраненного маршрута
    document.querySelectorAll('.load-route').forEach(function(button) {
        button.addEventListener('click', function() {
            var routeId = this.getAttribute('data-route-id');

            fetch('/load_route/' + routeId + '/')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Ошибка: ' + data.error);
                        return;
                    }

                    // Подготавливаем данные для отображения
                    var routePoints = data.points.map(point => [point.lat, point.lon]);
                    var routeNames = data.points.map(point => point.place_name);

                    // Отображаем маршрут на карте
                    displayRoute(routePoints, routeNames, data.max_distance);

                    // Выделяем чекбоксы
                    selectedMarkers.clear();
                    data.points.forEach(point => {
                        selectedMarkers.add(point.place_id);
                    });
                    updateCheckboxesFromSelection();
                    updateMarkersAppearance();

                    // Обновляем поле расстояния
                    document.querySelector('input[name="distance"]').value = data.max_distance;

                    alert('Маршрут "' + data.name + '" загружен!');
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при загрузке маршрута');
                });
        });
    });

    // 6. Удаление маршрута
    document.querySelectorAll('.delete-route').forEach(function(button) {
        button.addEventListener('click', function() {
            var routeId = this.getAttribute('data-route-id');

            if (confirm('Вы уверены, что хотите удалить этот маршрут?')) {
                fetch('/delete_route/' + routeId + '/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Ошибка при удалении маршрута');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при удалении маршрута');
                });
            }
        });
    });

    // 7. Функции для выделения области (остаются без изменений)
    // ... (все функции startDrawing, finishDrawing, clearSelection, updatePolygon,
    // updateSelectionFromPolygon, isPointInPolygon, togglePlaceSelection,
    // updateCheckboxesFromSelection, updateMarkersAppearance остаются такими же)

    // 8. Инициализация обработчиков кнопок выделения
    document.getElementById('startDrawing').addEventListener('click', startDrawing);
    document.getElementById('finishDrawing').addEventListener('click', finishDrawing);
    document.getElementById('clearSelection').addEventListener('click', clearSelection);

    // 9. Инициализация выбранных маркеров из формы
    document.addEventListener('DOMContentLoaded', function() {
        var initialCheckboxes = document.querySelectorAll('input[name="places"]:checked');
        initialCheckboxes.forEach(function(checkbox) {
            selectedMarkers.add(parseInt(checkbox.value));
        });
        updateMarkersAppearance();
    });

    // 10. Если есть текущий маршрут - отображаем его
    {% if route %}
        var routePoints = [
            {% for point in route %}
                [{{ point.lat|stringformat:"f" }}, {{ point.lon|stringformat:"f" }}],
            {% endfor %}
        ];

        var routeNames = [
            {% for point in route %}
                "{{ point.name }}",
            {% endfor %}
        ];

        displayRoute(routePoints, routeNames, {{ max_d }});
    {% endif %}

    // 11. Функции для выделения области (добавьте их сюда)
    function startDrawing() {
        isDrawing = true;
        polygonPoints = [];
        clearSelectionVisuals();
        document.getElementById('startDrawing').disabled = true;
        document.getElementById('finishDrawing').disabled = false;
        document.getElementById('startDrawing').classList.add('selection-active');
        map.doubleClickZoom.disable();
        updateDrawingHint('Кликайте на карте, чтобы добавить точки области. Двойной клик - завершить.');
    }

    function finishDrawing() {
        if (polygonPoints.length >= 3) {
            isDrawing = false;
            document.getElementById('startDrawing').disabled = false;
            document.getElementById('finishDrawing').disabled = true;
            document.getElementById('startDrawing').classList.remove('selection-active');
            map.doubleClickZoom.enable();
            updateSelectionFromPolygon();
            updateDrawingHint('Выделение завершено. Выбранные места отмечены.');
        } else {
            alert('Добавьте как минимум 3 точки для создания области');
        }
    }

    function clearSelection() {
        isDrawing = false;
        polygonPoints = [];
        clearSelectionVisuals();
        document.getElementById('startDrawing').disabled = false;
        document.getElementById('finishDrawing').disabled = true;
        document.getElementById('startDrawing').classList.remove('selection-active');
        map.doubleClickZoom.enable();
        selectedMarkers.clear();
        updateCheckboxesFromSelection();
        updateMarkersAppearance();
        updateDrawingHint('Готов к выделению новой области.');
    }

    function clearSelectionVisuals() {
        if (selectionPolygon) {
            map.removeLayer(selectionPolygon);
            selectionPolygon = null;
        }
        pointMarkers.forEach(function(marker) {
            map.removeLayer(marker);
        });
        pointMarkers = [];
    }

    function updateDrawingHint(message) {
        var hintElement = document.querySelector('.drawing-controls .form-text');
        if (hintElement) {
            hintElement.innerHTML = '' + message;
        }
    }

    function updatePolygon() {
        if (selectionPolygon) {
            map.removeLayer(selectionPolygon);
        }
        if (polygonPoints.length >= 3) {
            var polygonPointsArray = [];
            if (polygonPoints.length === 3) {
                polygonPointsArray = [polygonPoints[0], polygonPoints[1], polygonPoints[2]];
            } else if (polygonPoints.length > 3) {
                polygonPointsArray = [polygonPoints[0], polygonPoints[1]];
                for (var i = 2; i < polygonPoints.length; i++) {
                    polygonPointsArray.push(polygonPoints[i]);
                }
                polygonPointsArray.push(polygonPoints[0]);
            }
            selectionPolygon = L.polygon(polygonPointsArray, {
                color: 'blue',
                fillColor: '#3388ff',
                fillOpacity: 0.3,
                weight: 3
            }).addTo(map);
            updateSelectionFromPolygon();
        }
    }

    function updateSelectionFromPolygon() {
        if (!selectionPolygon || polygonPoints.length < 3) return;
        selectedMarkers.clear();
        markers.forEach(function(marker) {
            var latlng = marker.getLatLng();
            if (isPointInPolygon(latlng, polygonPoints)) {
                selectedMarkers.add(marker.placeId);
            }
        });
        updateCheckboxesFromSelection();
        updateMarkersAppearance();
    }

    function isPointInPolygon(point, vs) {
        var x = point.lat, y = point.lng;
        var inside = false;
        for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {
            var xi = vs[i].lat, yi = vs[i].lng;
            var xj = vs[j].lat, yj = vs[j].lng;
            var intersect = ((yi > y) != (yj > y))
                && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    }

    function togglePlaceSelection(placeId) {
        if (selectedMarkers.has(placeId)) {
            selectedMarkers.delete(placeId);
        } else {
            selectedMarkers.add(placeId);
        }
        updateCheckboxesFromSelection();
        updateMarkersAppearance();
    }

    function updateCheckboxesFromSelection() {
        var checkboxes = document.querySelectorAll('input[name="places"]');
        checkboxes.forEach(function(checkbox) {
            checkbox.checked = selectedMarkers.has(parseInt(checkbox.value));
        });
    }

    function updateMarkersAppearance() {
        markers.forEach(function(marker) {
            if (selectedMarkers.has(marker.placeId)) {
                marker.setIcon(selectedIcon);
            } else {
                marker.setIcon(defaultIcon);
            }
        });
    }

    map.on('click', function(e) {
        if (isDrawing) {
            polygonPoints.push(e.latlng);
            var pointMarker = L.circleMarker(e.latlng, {
                radius: 6,
                fillColor: 'red',
                color: 'darkred',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            pointMarkers.push(pointMarker);
            updatePolygon();
        }
    });

    map.on('dblclick', function(e) {
        if (isDrawing && polygonPoints.length >= 3) {
            finishDrawing();
        }
    });
</script>

</body>
</html>