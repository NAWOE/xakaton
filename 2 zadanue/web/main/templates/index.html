<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢—É—Ä—ã –ø–æ –í–æ–ª–æ–≥–¥–µ</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–∞—Ä—Ç—É Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 600px; width: 100%; border-radius: 10px; }
        .place-item { cursor: pointer; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4">
    <h1 class="text-center mb-4">üö∂ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–∞—Ä—à—Ä—É—Ç–∞ (–í–æ–ª–æ–≥–¥–∞)</h1>

    <div class="row">
        <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="col-md-4">
            <div class="card p-3 shadow-sm">
                <form method="post">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ (–º–µ—Ç—Ä—ã):</label>
                        <input type="number" name="distance" value="{{ max_d }}" class="form-control" required>
                    </div>

                    <h5>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞:</h5>
                    <div class="list-group mb-3">
                        {% for place in places %}
                        <label class="list-group-item">
                            <input class="form-check-input me-1" type="checkbox" name="places" value="{{ place.id }}"
                                   {% if place.id in selected_ids %}checked{% endif %}>
                            {{ place.name }}
                        </label>
                        {% endfor %}
                    </div>

                    <button type="submit" class="btn btn-primary w-100">üöÄ –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
                </form>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
            {% if route %}
            <div class="card mt-3 p-3 border-success shadow-sm">
                <h5 class="text-success">–ù–∞–π–¥–µ–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç ({{ route|length }} –æ–±—ä–µ–∫—Ç–æ–≤):</h5>
                <ol>
                    {% for point in route %}
                        <li>{{ point.name }}</li>
                    {% endfor %}
                </ol>
            </div>
            {% endif %}
        </div>

        <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ö–∞—Ä—Ç–∞ -->
        <div class="col-md-8">
            <div id="map" class="shadow-sm"></div>
        </div>
    </div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç—ã –∫–∞—Ä—Ç—ã -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (—Ü–µ–Ω—Ç—Ä –í–æ–ª–æ–≥–¥—ã)
    var map = L.map('map').setView([59.2239, 39.8825], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // 2. –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
    var placesData = [
        {% for place in places %}
            {
                id: {{ place.id }},
                name: "{{ place.name }}",
                lat: {{ place.lat|stringformat:"f" }}, // —Ö–∞–∫ –¥–ª—è –∑–∞–º–µ–Ω—ã –∑–∞–ø—è—Ç–æ–π –Ω–∞ —Ç–æ—á–∫—É
                lon: {{ place.lon|stringformat:"f" }}
            },
        {% endfor %}
    ];

    placesData.forEach(function(p) {
        L.marker([p.lat, p.lon]).addTo(map)
            .bindPopup("<b>" + p.name + "</b>");
    });

    // 3. –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç - —Ä–∏—Å—É–µ–º –ª–∏–Ω–∏—é
    {% if route %}
        var routePoints = [
            {% for point in route %}
                [{{ point.lat|stringformat:"f" }}, {{ point.lon|stringformat:"f" }}],
            {% endfor %}
        ];

        // –†–∏—Å—É–µ–º –∫—Ä–∞—Å–Ω—É—é –ª–∏–Ω–∏—é
        var polyline = L.polyline(routePoints, {color: 'red', weight: 5}).addTo(map);
        // –ó—É–º–º–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –≤–µ—Å—å –º–∞—Ä—à—Ä—É—Ç
        map.fitBounds(polyline.getBounds());
    {% endif %}
</script>

</body>
</html>